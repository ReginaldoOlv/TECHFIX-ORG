<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TechFix ‚Äî Acompanhar Servi√ßo</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Nunito:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --roxo:   #9b5de5; --roxo-c: #c77dff; --roxo-e: #6a0dad;
      --fundo:  #0a0a0f; --fundo2: #100d1a; --card: #1a1428;
      --texto:  #f0eaff; --suave: #8b80a8; --borda: rgba(155,93,229,0.2);
      --verde:  #25D366; --laranja: #f59e0b; --azul: #3b82f6;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Nunito', sans-serif; background: var(--fundo); color: var(--texto); min-height: 100vh;
           display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; }
    h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; }

    .logo { font-size: 1.8rem; font-weight: 700; margin-bottom: .3rem;
      background: linear-gradient(90deg, var(--roxo-c), var(--roxo));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .logo span { color: white; -webkit-text-fill-color: white; }
    .sub { color: var(--suave); font-size: .85rem; margin-bottom: 2.5rem; }

    .box {
      background: var(--card); border: 1px solid var(--borda); border-radius: 20px;
      padding: 2rem; width: 100%; max-width: 500px;
    }
    .box h2 { font-size: 1.15rem; margin-bottom: .4rem; }
    .box p  { color: var(--suave); font-size: .85rem; margin-bottom: 1.5rem; line-height: 1.6; }

    .campo { display: flex; flex-direction: column; gap: .3rem; margin-bottom: 1rem; }
    .campo label { font-size: .78rem; color: var(--suave); font-weight: 600; }
    .campo input {
      background: var(--fundo2); border: 1px solid var(--borda); border-radius: 10px;
      padding: .7rem 1rem; color: var(--texto); font-family: 'Nunito', sans-serif;
      font-size: .95rem; outline: none; transition: border-color .2s;
    }
    .campo input:focus { border-color: var(--roxo); }

    .btn-buscar {
      width: 100%; padding: .8rem; border-radius: 10px; border: none;
      background: linear-gradient(135deg, var(--roxo), var(--roxo-e));
      color: #fff; font-weight: 700; font-size: .95rem; cursor: pointer;
      font-family: 'Nunito', sans-serif; transition: opacity .2s; margin-top: .3rem;
    }
    .btn-buscar:hover { opacity: .9; }
    .btn-buscar:disabled { opacity: .5; cursor: not-allowed; }

    /* RESULTADOS */
    #resultado { width: 100%; max-width: 500px; margin-top: 1.5rem; }

    .card-servico {
      background: var(--card); border: 1px solid var(--borda); border-radius: 16px;
      padding: 1.5rem; margin-bottom: 1rem; animation: subir .4s ease both;
    }
    @keyframes subir { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:none; } }

    .cs-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .cs-titulo { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 700; }
    .cs-data   { font-size: .75rem; color: var(--suave); }

    .badge {
      display: inline-block; padding: .25rem .75rem; border-radius: 50px;
      font-size: .72rem; font-weight: 700; white-space: nowrap;
    }
    .b-novo      { background: rgba(59,130,246,0.15);  color: #60a5fa; }
    .b-andamento { background: rgba(245,158,11,0.15);  color: #fbbf24; }
    .b-concluido { background: rgba(37,211,102,0.15);  color: #4ade80; }
    .b-cancelado { background: rgba(239,68,68,0.15);   color: #f87171; }

    .linha { display: flex; justify-content: space-between; padding: .45rem 0;
             border-bottom: 1px solid var(--borda); font-size: .875rem; }
    .linha:last-child { border-bottom: none; }
    .linha span:first-child { color: var(--suave); }
    .linha span:last-child  { font-weight: 600; text-align: right; }

    /* TIMELINE */
    .timeline { margin-top: 1.2rem; }
    .tl-titulo { font-size: .78rem; color: var(--suave); text-transform: uppercase;
                 letter-spacing: .06em; margin-bottom: .8rem; font-weight: 700; }
    .tl-item { display: flex; gap: .75rem; align-items: flex-start; margin-bottom: .75rem; }
    .tl-dot {
      width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; margin-top: 3px;
      border: 2px solid var(--borda);
    }
    .tl-dot.ativo   { background: var(--roxo); border-color: var(--roxo); box-shadow: 0 0 8px var(--roxo); }
    .tl-dot.feito   { background: var(--verde); border-color: var(--verde); }
    .tl-dot.inativo { background: transparent; }
    .tl-texto { font-size: .85rem; }
    .tl-texto strong { display: block; font-weight: 600; }
    .tl-texto span   { color: var(--suave); font-size: .78rem; }

    /* ESTADO VAZIO / ERRO */
    .estado {
      background: var(--card); border: 1px solid var(--borda); border-radius: 16px;
      padding: 2.5rem 1.5rem; text-align: center; color: var(--suave);
    }
    .estado .icone { font-size: 2.5rem; margin-bottom: .8rem; }
    .estado p { font-size: .9rem; line-height: 1.6; }

    /* LOADING */
    .sp {
      display: inline-block; width: 20px; height: 20px;
      border: 2px solid var(--borda); border-top-color: var(--roxo);
      border-radius: 50%; animation: gir .7s linear infinite; vertical-align: middle; margin-right: .5rem;
    }
    @keyframes gir { to { transform: rotate(360deg); } }

    .link-voltar {
      margin-top: 2rem; color: var(--suave); font-size: .85rem; text-decoration: none;
      display: flex; align-items: center; gap: .4rem; transition: color .2s;
    }
    .link-voltar:hover { color: var(--roxo-c); }
  </style>
</head>
<body>

  <div class="logo">Tech<span>Fix</span></div>
  <p class="sub">Assist√™ncia t√©cnica em Curitiba e Regi√£o Metropolitana</p>

  <!-- FORMUL√ÅRIO DE BUSCA -->
  <div class="box">
    <h2>üì± Acompanhar meu servi√ßo</h2>
    <p>Digite o n√∫mero de WhatsApp que voc√™ usou ao solicitar o or√ßamento para ver o status do seu atendimento.</p>

    <div class="campo">
      <label>Seu WhatsApp (somente n√∫meros)</label>
      <input type="tel" id="inp-wpp" placeholder="Ex: 41988880001" maxlength="15"
             oninput="this.value=this.value.replace(/\D/g,'')"
             onkeydown="if(event.key==='Enter') buscar()"/>
    </div>
    <button class="btn-buscar" id="btn-buscar" onclick="buscar()">üîç Buscar meu atendimento</button>
  </div>

  <!-- RESULTADOS -->
  <div id="resultado"></div>

  <a href="index.html" class="link-voltar">‚Üê Voltar para o site</a>


<script>
  const SUPA_URL = 'https://pfigjyvhczzvcjseueoa.supabase.co';
  const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmaWdqeXZoY3p6dmNqc2V1ZW9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTE1NTEsImV4cCI6MjA4NzQyNzU1MX0.tl8aNDsA8ITt50oielqRz5Oja6xjLIR2xT8Khk3AqGk';

  const H = { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}` };

  async function buscar() {
    const wpp = document.getElementById('inp-wpp').value.trim().replace(/\D/g, '');
    const res = document.getElementById('resultado');
    const btn = document.getElementById('btn-buscar');

    if (wpp.length < 10) {
      res.innerHTML = `<div class="estado"><div class="icone">‚ö†Ô∏è</div><p>Digite um n√∫mero de WhatsApp v√°lido (com DDD).</p></div>`;
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="sp"></span> Buscando...';
    res.innerHTML = '';

    try {
      // Busca cliente pelo WhatsApp
      const rCli = await fetch(`${SUPA_URL}/rest/v1/clientes?whatsapp=eq.${wpp}&select=id,nome,whatsapp,cidade&limit=1`, { headers: H });
      const clientes = await rCli.json();

      if (!clientes.length) {
        res.innerHTML = `<div class="estado"><div class="icone">üîç</div><p>Nenhum cadastro encontrado com este n√∫mero.<br>Verifique o n√∫mero ou entre em contato pelo WhatsApp.</p></div>`;
        return;
      }

      const cli = clientes[0];

      // Busca or√ßamentos e servi√ßos do cliente
      const [rOrc, rServ] = await Promise.all([
        fetch(`${SUPA_URL}/rest/v1/orcamentos?cliente_id=eq.${cli.id}&order=criado_em.desc`, { headers: H }),
        fetch(`${SUPA_URL}/rest/v1/servicos_realizados?cliente_id=eq.${cli.id}&order=criado_em.desc`, { headers: H })
      ]);
      const orcamentos = await rOrc.json();
      const servicos   = await rServ.json();

      if (!orcamentos.length && !servicos.length) {
        res.innerHTML = `<div class="estado"><div class="icone">üì≠</div><p>Ol√°, <strong>${cli.nome}</strong>!<br>N√£o encontramos nenhum atendimento para este n√∫mero ainda.</p></div>`;
        return;
      }

      let html = `<p style="color:var(--suave);font-size:.85rem;margin-bottom:1rem">Encontramos ${orcamentos.length} pedido(s) para <strong style="color:var(--texto)">${cli.nome}</strong>:</p>`;

      // Renderiza cada or√ßamento com status
      orcamentos.forEach(o => {
        const serv = servicos.find(s => s.orcamento_id === o.id);
        html += renderCardAcompanhamento(o, serv);
      });

      res.innerHTML = html;

    } catch(e) {
      res.innerHTML = `<div class="estado"><div class="icone">‚ùå</div><p>Erro ao buscar. Tente novamente em instantes.</p></div>`;
      console.error(e);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üîç Buscar meu atendimento';
    }
  }

  function renderCardAcompanhamento(o, serv) {
    const statusLabel = { novo:'Aguardando t√©cnico', em_andamento:'Em atendimento', concluido:'Conclu√≠do', cancelado:'Cancelado' };
    const statusClass = { novo:'b-novo', em_andamento:'b-andamento', concluido:'b-concluido', cancelado:'b-cancelado' };

    // Timeline baseada no status
    const etapas = [
      { key: 'novo',         label: 'Pedido recebido',       desc: 'Or√ßamento enviado pelo site' },
      { key: 'em_andamento', label: 'T√©cnico respons√°vel',   desc: o.status !== 'novo' ? `${o.tecnico} assumiu o servi√ßo` : 'Aguardando t√©cnico dispon√≠vel' },
      { key: 'concluido',    label: 'Servi√ßo conclu√≠do',     desc: serv?.data_saida ? `Conclu√≠do em ${serv.data_saida}` : 'Aguardando conclus√£o' },
    ];

    const ordemStatus = ['novo','em_andamento','concluido'];
    const idxAtual = ordemStatus.indexOf(o.status);

    const timelineHtml = etapas.map((e, i) => {
      const isCancelado = o.status === 'cancelado';
      const feito  = !isCancelado && i < idxAtual;
      const ativo  = !isCancelado && i === idxAtual;
      const dot    = feito ? 'feito' : ativo ? 'ativo' : 'inativo';
      return `<div class="tl-item">
        <div class="tl-dot ${dot}"></div>
        <div class="tl-texto">
          <strong style="${feito?'color:#4ade80':ativo?'color:var(--roxo-c)':'color:var(--suave)'}">${e.label}</strong>
          <span>${e.desc}</span>
        </div>
      </div>`;
    }).join('');

    return `<div class="card-servico">
      <div class="cs-header">
        <div>
          <div class="cs-titulo">${o.dispositivo}${o.marca?' ‚Äî '+o.marca:''}</div>
          <div class="cs-data">${fmtData(o.criado_em)}</div>
        </div>
        <span class="badge ${statusClass[o.status]||''}">${statusLabel[o.status]||o.status}</span>
      </div>

      <div class="linha"><span>üîß Servi√ßos</span><span>${(o.servicos||[]).join(', ')}</span></div>
      <div class="linha"><span>‚è±Ô∏è Urg√™ncia</span><span>${o.urgencia||'‚Äî'}</span></div>
      <div class="linha"><span>üë®‚Äçüîß T√©cnico</span>
        <span>${o.status==='novo'
          ? '<span style="color:var(--suave)">Aguardando designa√ß√£o</span>'
          : o.tecnico}</span>
      </div>
      ${serv?.valor_cobrado ? `<div class="linha"><span>üí∞ Valor</span><span>R$ ${parseFloat(serv.valor_cobrado).toFixed(2)}</span></div>` : ''}

      <div class="timeline">
        <div class="tl-titulo">Linha do tempo</div>
        ${o.status==='cancelado'
          ? '<div style="color:#f87171;font-size:.85rem">‚ùå Este atendimento foi cancelado.</div>'
          : timelineHtml}
      </div>
    </div>`;
  }

  function fmtData(iso) {
    if (!iso) return '‚Äî';
    return new Date(iso).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'2-digit', hour:'2-digit', minute:'2-digit' });
  }
</script>
</body>
</html>
